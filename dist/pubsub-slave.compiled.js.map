{"version":3,"sources":["pubsub-slave.es6"],"names":[],"mappings":"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","file":"pubsub-slave.es6","sourcesContent":["import ipc from 'node-ipc';\nimport async from 'async';\nimport EventEmitter from 'events';\nimport Promise from 'bluebird';\nimport crypto from 'crypto';\n\nconst noop = () => 0;\n\nconst defaultEventMap = {\n  delimiter: '-',\n\n  // request events\n  requestBroadcast: 'broadcast',\n  requestEmit: 'emit',\n  requestServerAddress: 'get-server-address',\n  requestAddToken: 'add-token',\n  requestRemoveToken: 'remove-token',\n  requestAuthorization: 'authorize',\n  requestDeauthorization: 'deauthorize',\n  requestPeerBroadcast: 'broadcast-peer',\n  requestPeerEmit: 'emit-peer',\n\n  // response events\n  responsePeerReceived: 'peer-got',\n  responseClientAwk: 'client-received',\n  responsePeerAwk: 'peer-received',\n  responseClientDisconnected: 'client-disconnected',\n  responsePeerMessage: 'peer-message',\n  responseClientConnected: 'client-connected',\n  responseServerAddress: 'server-address',\n  responseTokenAdded: 'token-added',\n  responseTokenRemoved: 'token-removed'\n};\n\nconst active = {};\n\nconst defaultOpts = {\n  resDefaultTimeout: 60000,\n  debug: false,\n  concurrency: 50,\n  scope: 'socket',\n  eventMap: defaultEventMap,\n  appspace: 'socket'\n};\n\nclass PubSubSlave extends EventEmitter {\n  constructor(origin, address, remote, opts = defaultOpts) {\n    super();\n\n    opts = Object.assign(defaultOpts, opts);\n\n    this.origin = origin;\n    this.opts = opts;\n    this.scope = opts.scope;\n    this.eventMap = Object.assign(defaultEventMap, opts.eventMap);\n    this.remoteAddress = address;\n    this.remote = remote;\n    this.resDefaultTimeout = opts.resDefaultTimeout;\n    this.debug = opts.debug;\n\n    this.setMaxListeners(Number.MAX_SAFE_INTEGER);\n\n    this.queue = async.queue((data, callback) => {\n      const _callback = () => process.nextTick(callback);\n      if (typeof data === 'function') {\n        if (data.length) {\n          data(_callback);\n        } else {\n          data();\n          _callback();\n        }\n\n        return;\n      }\n\n      this._handleTransmit(data, _callback);\n    }, opts.concurrency);\n\n    this.queue.pause();\n  }\n\n  peer = {\n    broadcast: this.peerBroadcast.bind(this),\n    volatile: this.peerVolatile.bind(this),\n    emit: this.peerEmit.bind(this),\n    emitCB: this.peerEmitCB.bind(this)\n  }\n\n  peerBroadcast(channel, data) {\n    this.queue.push({channel, action: this.eventMap.requestPeerBroadcast, data, awk: true});\n  }\n\n  peerVolatile(dest, channel, data) {\n    this.peerEmit(dest, channel, data, false);\n  }\n\n  peerEmit(dest, channel, data, awk = true) {\n    if (!awk) {\n      return this.queue.push({action: this.eventMap.requestPeerEmit, channel, data, dest});\n    }\n\n    return new Promise((resolve, reject) => {\n      this.queue.push({action: this.eventMap.requestPeerEmit, channel, data, awk, dest, resolve, reject});\n    });\n  }\n\n  peerEmitCB(dest, channel, data, resolve, reject) {\n    this.queue.push({dest, channel, action: this.eventMap.requestPeerEmit, data, awk: true, resolve, reject});\n  }\n\n  // private emit\n  _emit(...args) {\n    super.emit(...args);\n  }\n\n  resolveHost(address) {\n    let host = address.hostname || '0.0.0.0';\n\n    if (host === 'localhost' || host === '::1' || host === '127.0.0.1') {\n      host = '0.0.0.0';\n    }\n\n    return host;\n  }\n\n  resolvePort(address) {\n    return address.port;\n  }\n\n  configure(_ipc) {\n    noop(_ipc);\n  }\n\n  connect() {\n    const eventMap = this.eventMap;\n    const address = this.remoteAddress;\n\n    if (!active.hasOwnProperty(this.scope)) {\n      active[this.scope] = {};\n    }\n\n    active[this.scope] = {[this.origin]: true};\n\n    ipc.config.retry = 5000;\n    ipc.config.maxRetries = 20;\n    ipc.config.silent = !this.debug;\n    ipc.config.networkHost = this.resolveHost(address);\n    ipc.config.networkPort = this.resolvePort(address);\n    ipc.config.appspace = this.opts.appspace;\n\n    this.configure(ipc);\n\n    return new Promise(resolve => {\n      ipc[this.remote ? 'connectToNet' : 'connectTo'](this.scope, () => {\n        ipc.config.stopRetrying = false;\n        resolve();\n\n        this.queue.unshift(() => {\n          const req = {\n            id: this.origin,\n            data: {origin: this.origin}\n          };\n\n          this._emitIPC(this.eventMap.requestAuthorization, req);\n        });\n\n        this.queue.resume();\n      });\n\n      ipc.of[this.scope].on('disconnect', () => {\n        this.queue.pause();\n      });\n\n      ipc.of[this.scope].on(eventMap.responseTokenAdded, data => {\n        if (data.origin !== this.origin) {\n          return;\n        }\n\n        data = this.unwrap(data, eventMap.responseTokenAdded).data;\n\n        this._emit(eventMap.responseTokenAdded, data);\n        this._emit(this.for(eventMap.responseTokenAdded, data.token), data);\n      });\n\n      ipc.of[this.scope].on(eventMap.responseServerAddress, data => {\n        if (data.origin !== this.origin) {\n          return;\n        }\n\n        data = this.unwrap(data, eventMap.responseServerAddress).data;\n\n        this._emit(eventMap.responseServerAddress, data);\n      });\n\n      ipc.of[this.scope].on(eventMap.responseTokenRemoved, data => {\n        if (data.origin !== this.origin) {\n          return;\n        }\n\n        data = this.unwrap(data, eventMap.responseTokenRemoved).data;\n\n        this._emit(eventMap.responseTokenRemoved, data);\n        this._emit(this.for(eventMap.responseTokenRemoved, data.token), data);\n      });\n\n      ipc.of[this.scope].on(eventMap.responseClientAwk, data => {\n        if (data.origin !== this.origin) {\n          return;\n        }\n\n        data = this.unwrap(data, eventMap.responseClientAwk).data;\n\n        this._emit(eventMap.responseClientAwk, data);\n        this._emit(this.for(eventMap.responseClientAwk, data.id), data);\n      });\n\n      ipc.of[this.scope].on(eventMap.responsePeerAwk, data => {\n        if (data.origin !== this.origin) {\n          return;\n        }\n\n        data = this.unwrap(data, eventMap.responsePeerAwk).data;\n\n        this._emit(eventMap.responsePeerAwk, data);\n        this._emit(this.for(eventMap.responsePeerAwk, data.id), data);\n      });\n\n      ipc.of[this.scope].on(eventMap.responseClientConnected, data => {\n        if (data.origin !== this.origin) {\n          return;\n        }\n\n        data = this.unwrap(data, eventMap.responseClientConnected).data;\n\n        this._emit(eventMap.responseClientConnected, data);\n        this._emit(this.for(eventMap.responseClientConnected, data.token), data);\n      });\n\n      ipc.of[this.scope].on(eventMap.responsePeerMessage, data => {\n        if (data.origin !== this.origin) {\n          return;\n        }\n\n        data = this.unwrap(data, eventMap.responsePeerMessage).data;\n\n        let v = 0;\n        const respond = res => {\n          if (v++) return;\n          const response = {id: this.origin, data: {...data, _data: data.data, data: res}};\n          this.queue.push(() => this._emitIPC(eventMap.responsePeerReceived, response));\n        };\n\n        this._emit(eventMap.responsePeerMessage, data, respond);\n        this._emit(this.for(eventMap.responsePeerMessage, data.channel, respond), data.data);\n\n        for (const e in this.eventMap) {\n          if (this.eventMap.hasOwnProperty(e)) {\n            if (data.channel === eventMap[e]) {\n              return;\n            }\n          }\n        }\n\n        this._emit(data.channel, data.data, respond);\n      });\n\n      ipc.of[this.scope].on(eventMap.responseClientDisconnected, data => {\n        data = this.unwrap(data, eventMap.responseClientDisconnected).data;\n\n        this._emit(eventMap.responseClientDisconnected, data);\n        this._emit(this.for(eventMap.responseClientDisconnected, data.token), data);\n      });\n    });\n  }\n\n  generateUUID() {\n    return crypto.randomBytes(10).toString('hex');\n  }\n\n  unwrap(data) {\n    return data || {data: {}};\n  }\n\n  wrap(data) {\n    return data;\n  }\n\n  _handleTransmit({token, dest, channel, data, resolve, action, reject, awk}, callback) {\n    const eventMap = this.eventMap;\n    const eventId = this.generateUUID();\n\n    if (action === this.eventMap.requestBroadcast ||\n      action === this.eventMap.requestPeerBroadcast) {\n      const req = {\n        id: this.origin,\n        data: {\n          dest,\n          id: eventId,\n          token,\n          channel,\n          data,\n          awk\n        }\n      };\n\n      this._emitIPC(action, req);\n\n      return callback();\n    }\n\n    let tid;\n    let event;\n\n    const accepted = res => {\n      clearTimeout(tid);\n      resolve(res.data);\n    };\n\n    const timeout = () => {\n      this.removeListener(event, accepted);\n      reject({token, channel, data, awk});\n    };\n\n    let awkChan;\n\n    if (action === eventMap.requestEmit) {\n      awkChan = eventMap.responseClientAwk;\n    } else {\n      awkChan = eventMap.responsePeerAwk;\n    }\n\n    if (awk) {\n      event = this.for(awkChan, eventId);\n\n      const wait = typeof awk === 'number' && awk > 0 ? awk : this.resDefaultTimeout;\n\n      this.once(event, accepted);\n      tid = setTimeout(timeout, wait);\n    }\n\n    const req = {\n      id: this.origin,\n      data: {\n        dest,\n        id: eventId,\n        token,\n        channel,\n        data,\n        awk\n      }\n    };\n\n    this._emitIPC(action, req);\n\n    callback();\n  }\n\n  for(event, id) {\n    return [event, id].join(this.eventMap.delimiter);\n  }\n\n  _emitIPC(event, data) {\n    ipc.of[this.scope].emit(event, this.wrap(data, event));\n  }\n\n  accept(token) {\n    const eventMap = this.eventMap;\n\n    return new Promise(resolve => {\n      if (eventMap.responseTokenAdded) {\n        this.once(this.for(eventMap.responseTokenAdded, token), data => resolve(data));\n      }\n\n      const req = {\n        id: this.origin,\n        data: {token}\n      };\n\n      this._emitIPC(eventMap.requestAddToken, req);\n\n      if (!eventMap.responseTokenAdded) {\n        resolve(token);\n      }\n    });\n  }\n\n  reject(token) {\n    const eventMap = this.eventMap;\n\n    return new Promise(resolve => {\n      if (eventMap.responseTokenRemoved) {\n        this.once(this.for(eventMap.responseTokenRemoved, token), () => {\n          resolve(token);\n        });\n      }\n\n      const req = {\n        id: this.origin,\n        data: {token}\n      };\n\n      this._emitIPC(eventMap.requestRemoveToken, req);\n\n      if (!eventMap.responseTokenRemoved) {\n        resolve(token);\n      }\n    });\n  }\n\n  volatile(token, channel, data) {\n    return this.emit(token, channel, data, false);\n  }\n\n  emit(token, channel, data, awk = true) {\n    if (!awk) {\n      return this.queue.push({token, action: this.eventMap.requestEmit, channel, data});\n    }\n\n    return new Promise((resolve, reject) => {\n      this.queue.push({token, action: this.eventMap.requestEmit, channel, data, awk, resolve, reject});\n    });\n  }\n\n  emitCB(token, channel, data, resolve, reject) {\n    this.queue.push({token, channel, action: this.eventMap.requestEmit, data, awk: true, resolve, reject});\n  }\n\n  address() {\n    if (!this._address) {\n      this._address = new Promise(resolve => {\n        this.queue.push(callback => {\n          this.once(this.eventMap.responseServerAddress, _address => resolve(_address));\n\n          const req = {\n            id: this.origin,\n            data: {}\n          };\n\n          this._emitIPC(this.eventMap.requestServerAddress, req);\n          callback();\n        });\n      });\n    }\n\n    return this._address;\n  }\n\n  broadcast(channel, data) {\n    this.queue.push({channel, action: this.eventMap.requestBroadcast, data, awk: true});\n  }\n\n  disconnect() {\n    if (active.hasOwnProperty(this.scope)) {\n      delete active[this.scope][this.origin];\n\n      const sync = ipc.config.sync;\n      ipc.config.sync = true;\n\n      // bypass queue\n      try {\n        ipc.of[this.scope].emit(this.eventMap.requestDeauthorization, {id: this.origin, data: {origin: this.origin}});\n      } catch (e) {\n        // ignore\n      }\n\n      ipc.config.sync = sync;\n\n      if (!active[this.scope].length) {\n        ipc.disconnect(this.scope);\n      }\n    }\n  }\n\n  isRemote() {\n    return this.remote;\n  }\n\n  isLocal() {\n    return !this.remote;\n  }\n}\n\nexport default PubSubSlave;\n"]}