{"version":3,"sources":["slave.es6"],"names":[],"mappings":"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","file":"slave.es6","sourcesContent":["import EventEmitter from 'events';\nimport crypto from 'crypto';\nimport Loki from 'lokijs';\nimport exitHook from 'exit-hook';\nimport fs from 'fs';\n\nconst dbFile = 'accepted.cache.json';\n\nexport default class Slave extends EventEmitter {\n  constructor(debug = true) {\n    super();\n\n    const db = new Loki();\n\n    const accepted = db.addCollection('accepted');\n\n    this.debug = debug;\n    this.accepted = accepted;\n    this.on('error', err => console.error(err));\n\n    this._restore();\n\n    exitHook(() => this._dump());\n  }\n\n  _restore() {\n    try {\n      const res = JSON.parse(fs.readFileSync(dbFile, 'utf8'));\n\n      this.accepted.insert(...res);\n    } catch (e) {\n      // ignore\n    }\n  }\n\n  _dump() {\n    const res = this.accepted.find();\n\n    try {\n      fs.writeFileSync(dbFile, JSON.stringify(res), 'utf8');\n    } catch (e) {\n      // ignore\n    }\n  }\n\n  // privatizing\n  _emit(...args) {\n    return super.emit(...args);\n  }\n\n  tokens() {\n    let tokens = [];\n\n    for (const [, toks] of Object.entries(this.origins)) {\n      tokens = tokens.concat(toks);\n    }\n  }\n\n  accept(origin, token) {\n    let res = this.accepted.findOne({token, origin});\n\n    if (!res) {\n      const uuid = crypto.randomBytes(20).toString('hex');\n\n      // TODO ensure unique\n      res = this.accepted.insert({origin, token, uuid});\n    }\n\n    return res.uuid;\n  }\n\n  isAccepted(uuid) {\n    const res = this.accepted.findOne({uuid});\n    return res && res.uuid;\n  }\n\n  originOf(uuid) {\n    const res = this.accepted.findOne({uuid});\n    return res;\n  }\n\n  uuidOf(origin, token) {\n    origin = origin || '<stopper>';\n    token = token || '<stopper>';\n\n    const res = this.accepted.findOne({token, origin});\n\n    return res && res.uuid;\n  }\n\n  reject(origin, token) {\n    const res = this.accepted.findOne({token, origin});\n\n    try {\n      this.accepted.remove(res);\n\n      return res.uuid;\n    } catch (e) {\n      // ignore\n    }\n  }\n\n  log(...args) {\n    if (this.debug) {\n      console.log(...args);\n    }\n  }\n\n  attach(server) {\n    throw new Error('Not implemented', server);\n  }\n\n  emit(origin, token, channel, data) {\n    throw new Error('Not implemented', origin, channel, token, data);\n  }\n\n  broadcast(origin, channel, data) {\n    throw new Error('Not implemented', origin, channel, data);\n  }\n}\n"]}