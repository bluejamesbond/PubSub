{"version":3,"sources":["../../src/client-com/sio.es6"],"names":[],"mappings":"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","file":"sio.es6","sourcesContent":["import io from 'socket.io';\nimport ClientCom from '../client-com.es6';\n\nexport class SocketIO extends ClientCom {\n  constructor(debug = true) {\n    super(debug);\n    this.sio = io();\n    this.connected = new Map();\n  }\n\n  attach(server) {\n    this.sio.on('connection', socket => this._onConnect(socket));\n    this.sio.attach(server);\n  }\n\n  accept(origin, token) {\n    const uuid = super.accept(origin, token);\n\n    this.log('added uuid', uuid);\n\n    this._emit('token-added', origin, {token, uuid});\n  }\n\n  reject(origin, token) {\n    const uuid = super.reject(origin, token);\n\n    this.log('removed uuid', uuid);\n\n    if (uuid) {\n      const currSocket = this.connected.get(uuid);\n      SocketIO.terminate(currSocket);\n\n      this.connected.delete(token);\n    }\n\n    this._emit('token-removed', origin, {token});\n  }\n\n  // TODO awk?\n  broadcast(channel, data) {\n    this.sio.sockets.emit(channel, data);\n  }\n\n  // FIXME respond with client-error?\n  emit(origin, token, channel, id, data, awk = true) {\n    const uuid = this.uuidOf(origin, token);\n    const socket = this.connected.get(uuid);\n\n    if (socket) {\n      this.log(`socket exists on ${token}`);\n\n      // FIXME too much scoping?\n      try {\n        if (!awk) {\n          socket.emit(channel, data);\n        } else {\n          socket.emit(channel, data, res => {\n            this._emit('client-received', origin, {token, channel, id, _data: data, data: res}); // awk\n          });\n        }\n\n        this.log(`socket data emitted ${token}/${channel}`, data);\n      } catch (e) {\n        console.error(e);\n        // ignore\n      }\n    } else {\n      this.log(`token does not exist: ${token}`);\n    }\n  }\n\n  static terminate(socket) {\n    if (!socket) {\n      return;\n    }\n\n    try {\n      socket.emit('termination', {data: 'forced disconnection'});\n      socket.disconnect();\n    } catch (e) {\n      console.error(e);\n    }\n  }\n\n  _onConnect(socket) {\n    const uuid = socket.handshake.query.id;\n\n    if (this.isAccepted(uuid)) {\n      const {origin, token} = this.originOf(uuid);\n      const currSocket = this.connected.get(uuid);\n\n      SocketIO.terminate(currSocket);\n\n      this.connected.set(uuid, socket);\n\n      this.log(`server connected to client with token: ${token}`);\n\n      socket.on('disconnect', () => {\n        this.log(`socket disconnected with token: ${token}`);\n\n        this.connected.delete(uuid);\n\n        this._emit('client-disconnected', origin, {token});\n      });\n    } else {\n      console.log('socket uuid not found', uuid);\n\n      SocketIO.terminate(socket);\n    }\n  }\n}\n\nexport default SocketIO;\n"]}